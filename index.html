<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OLX Command Center</title>
    <style>
        :root { --main-blue: #007bff; --light-blue: #e0eafc; --ai-purple: #563d7c; --gray-bg: #f4f4f5; --light-gray: #e9e9eb; --text-dark: #111; --text-light: #555; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; margin: 0; height: 100vh; background-color: var(--gray-bg); font-size: 14px; overflow: hidden; }
        * { box-sizing: border-box; }

        #sidebar { width: 350px; border-right: 1px solid #ccc; height: 100%; display: flex; flex-direction: column; background-color: #fff; flex-shrink: 0; }
        .sidebar-header { padding: 10px 15px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { margin: 0; font-size: 1.2em; color: #333; }
        .sidebar-controls { display: flex; align-items: center; font-size: 12px; }
        .sidebar-controls label { margin-right: 10px; }
        .sidebar-controls button { background: none; border: 1px solid #ccc; cursor: pointer; border-radius: 5px; padding: 5px 8px; }
        #threads-list { flex-grow: 1; overflow-y: auto; }
        
        #broadcast-section { padding: 10px; border-top: 1px solid #ccc; }
        #broadcast-section textarea { width: 100%; resize: vertical; padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 5px; }
        #broadcast-section button { width: 100%; padding: 10px; background-color: var(--ai-purple); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        #broadcast-section button:disabled { background-color: #ccc; }

        .thread-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: flex-start; }
        .thread-item:hover { background-color: #f0f0f0; }
        .thread-item.active { background-color: var(--light-blue); }
        .thread-item input[type="checkbox"] { margin-right: 12px; margin-top: 4px; flex-shrink: 0; }
        .thread-item-info { flex-grow: 1; min-width: 0; }
        .thread-item-info p, .thread-item-info small { margin: 0; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .thread-item-info p { font-weight: 500; color: var(--text-dark); }
        .thread-item.unread .user-name, .thread-item.unread .advert-title { font-weight: bold; color: var(--text-dark); }

        #main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100%; }
        #content-area { flex-grow: 1; display: flex; flex-direction: column; background-color: #fff; }
        .placeholder { text-align: center; color: #888; margin: auto; }
        
        #chat-header { display: none; align-items: center; padding: 10px; border-bottom: 1px solid #ccc; background-color: #f9f9f9; flex-shrink: 0; }
        #back-to-threads-button { font-size: 20px; background: none; border: none; cursor: pointer; padding: 0 15px 0 5px; }
        #chat-partner-name { margin: 0; font-size: 1.1em; font-weight: bold; }

        #analyzer-section { padding: 15px; border-bottom: 1px solid #ccc; background-color: #fafafa; }
        #analyzer-section p { margin: 0 0 10px 0; font-weight: bold; }
        .analyzer-input-group { display: flex; }
        #analyzer-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 5px; padding: 8px; }
        #analyzer-button { margin-left: 10px; background-color: var(--ai-purple); color: white; border:none; border-radius:5px; padding: 0 15px; font-weight: bold; cursor: pointer; }
        #analyzer-result { margin-top: 10px; padding: 10px; background-color: #eef; border-radius: 5px; color: #333; }

        #messages-view { flex-grow: 1; padding: 20px; overflow-y: auto; background-color: var(--gray-bg); }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 18px; max-width: 80%; width: fit-content; word-wrap: break-word; line-height: 1.4; }
        .message.sent { background-color: var(--main-blue); color: white; margin-left: auto; }
        .message.received { background-color: var(--light-gray); color: black; margin-right: auto; }
        #messages-container { display: flex; flex-direction: column; }

        #reply-area { border-top: 1px solid #ccc; padding: 10px; display: flex; background-color: #f9f9f9; align-items: flex-end; flex-shrink: 0; }
        #reply-area textarea { flex-grow: 1; resize: none; border-radius: 18px; border: 1px solid #ccc; padding: 10px; font-size: 16px; line-height: 1.4; max-height: 100px; }
        #reply-area button { margin-left: 10px; width: 42px; height: 42px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; transition: background-color 0.2s; flex-shrink: 0; padding: 0; font-size: 20px; }
        #reply-area button#send-button { background-color: var(--main-blue); color: white; }
        #reply-area button#generate-ai-button { background-color: var(--ai-purple); color: white; font-size: 16px; }
        #reply-area button:disabled { background-color: #ccc; cursor: not-allowed; }

        #settings-view { padding: 20px; height: 100%; overflow-y: auto; }
        #settings-view h2 { margin-top: 0; }
        #settings-view textarea { width: 100%; height: 200px; resize: vertical; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #settings-view button { padding: 10px 20px; background-color: var(--main-blue); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .status-message { margin-top: 10px; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }

        .hidden { display: none !important; }
        #loader, #messages-loader { text-align: center; padding: 20px; color: #888; }
        
        @media (max-width: 768px) {
            body { font-size: 16px; }
            #sidebar { width: 100%; border-right: none; }
            #main-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
            #main-content.visible { transform: translateX(0); }
            
            #chat-header { display: flex; }
            #send-button { font-size: 16px; }
            #send-button::before { content: '‚û§'; }
            #send-button span { display: none; }
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <h2>–†–∞–∑–≥–æ–≤–æ—Ä–∏</h2>
            <div class="sidebar-controls">
                <label><input type="checkbox" id="select-all-checkbox"> –í—Å–∏—á–∫–∏</label>
                <button id="refresh-button">üîÑ</button>
                <button id="settings-button">‚öôÔ∏è</button>
            </div>
        </div>
        <div id="loader">–ó–∞—Ä–µ–∂–¥–∞–º —Ä–∞–∑–≥–æ–≤–æ—Ä–∏...</div>
        <div id="threads-list"></div>
        <div id="broadcast-section" class="hidden">
            <textarea id="broadcast-message" rows="4" placeholder="–ù–∞–ø–∏—à–µ—Ç–µ –≥—Ä—É–ø–æ–≤–æ —Å—ä–æ–±—â–µ–Ω–∏–µ..."></textarea>
            <button id="broadcast-button" disabled>–ò–∑–ø—Ä–∞—Ç–∏ –Ω–∞ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ (0)</button>
        </div>
    </div>

    <div id="main-content">
        <div id="content-area">
            <div id="placeholder-view" class="placeholder">
                <h1>OLX Command Center</h1>
                <p>–ò–∑–±–µ—Ä–µ—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä, –∑–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—Ç–µ.</p>
            </div>

            <div id="chat-view" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                <div id="chat-header">
                    <button id="back-to-threads-button">&larr;</button>
                    <h3 id="chat-partner-name"></h3>
                </div>
                <div id="analyzer-section">
                    <p>AI –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä</p>
                    <div class="analyzer-input-group">
                        <input type="text" id="analyzer-input" placeholder="–ù–∞–ø—Ä. '–ö–∞–∫—ä–≤ –µ –∞–¥—Ä–µ—Å—ä—Ç?'">
                        <button id="analyzer-button">–ü–∏—Ç–∞–π AI</button>
                    </div>
                    <div id="analyzer-result" class="hidden"></div>
                </div>
                <div id="messages-view"></div>
                <div id="reply-area">
                    <textarea id="reply-text" rows="1" placeholder="–û—Ç–≥–æ–≤–æ—Ä..."></textarea>
                    <button id="generate-ai-button" title="–ì–µ–Ω–µ—Ä–∏—Ä–∞–π —Å AI">‚ú®</button>
                    <button id="send-button" title="–ò–∑–ø—Ä–∞—Ç–∏"><span>–ò–∑–ø—Ä–∞—Ç–∏</span></button>
                </div>
            </div>

            <div id="settings-view" class="hidden">
                <div id="chat-header">
                    <button id="back-to-threads-button-settings">&larr;</button>
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                </div>
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ AI –ê—Å–∏—Å—Ç–µ–Ω—Ç–∞</h2>
                <p>–ü—Ä–æ–º–µ–Ω–µ—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–∏—è –ø—Ä–æ–º–ø—Ç, –∫–æ–π—Ç–æ AI –∏–∑–ø–æ–ª–∑–≤–∞, –∑–∞ –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏.</p>
                <textarea id="prompt-textarea"></textarea>
                <button id="save-prompt-button">–ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–ø—Ç–∞</button>
                <div id="status-message"></div>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        const API_BASE_URL = 'https://olx.radilov-k.workers.dev';
        const AUTH_URL = 'https://www.olx.bg/oauth/authorize?response_type=code&client_id=200383&redirect_uri=https://olx.radilov-k.workers.dev/callback&scope=read+write+v2&state=random_string_12345';
        
        let currentThreadId = null;
        const IS_MOBILE = window.innerWidth <= 768;

        const elements = {
            sidebar: document.getElementById('sidebar'),
            mainContent: document.getElementById('main-content'),
            loader: document.getElementById('loader'),
            threadsList: document.getElementById('threads-list'),
            selectAllCheckbox: document.getElementById('select-all-checkbox'),
            refreshButton: document.getElementById('refresh-button'),
            settingsButton: document.getElementById('settings-button'),
            broadcastSection: document.getElementById('broadcast-section'),
            broadcastMessage: document.getElementById('broadcast-message'),
            broadcastButton: document.getElementById('broadcast-button'),
            placeholderView: document.getElementById('placeholder-view'),
            chatView: document.getElementById('chat-view'),
            settingsView: document.getElementById('settings-view'),
            messagesView: document.getElementById('messages-view'),
            replyText: document.getElementById('reply-text'),
            sendButton: document.getElementById('send-button'),
            generateAiButton: document.getElementById('generate-ai-button'),
            analyzerInput: document.getElementById('analyzer-input'),
            analyzerButton: document.getElementById('analyzer-button'),
            analyzerResult: document.getElementById('analyzer-result'),
            promptTextarea: document.getElementById('prompt-textarea'),
            savePromptButton: document.getElementById('save-prompt-button'),
            statusMessage: document.getElementById('status-message'),
            chatPartnerName: document.getElementById('chat-partner-name'),
            backToThreadsButton: document.getElementById('back-to-threads-button'),
            backToThreadsButtonSettings: document.getElementById('back-to-threads-button-settings'),
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchThreads();
            
            elements.refreshButton.addEventListener('click', fetchThreads);
            elements.settingsButton.addEventListener('click', showSettingsView);
            elements.selectAllCheckbox.addEventListener('change', handleSelectAll);
            elements.threadsList.addEventListener('change', e => {
                if (e.target.classList.contains('thread-checkbox')) updateBroadcastCounter();
            });
            
            elements.sendButton.addEventListener('click', sendMessage);
            elements.replyText.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            elements.generateAiButton.addEventListener('click', generateAiReply);
            elements.analyzerButton.addEventListener('click', analyzeThread);
            elements.broadcastButton.addEventListener('click', sendBroadcastMessage);
            elements.savePromptButton.addEventListener('click', savePrompt);
            elements.backToThreadsButton.addEventListener('click', showThreadsViewOnMobile);
            elements.backToThreadsButtonSettings.addEventListener('click', showThreadsViewOnMobile);

            elements.replyText.addEventListener('input', () => {
                const el = elements.replyText;
                el.style.height = 'auto';
                el.style.height = (el.scrollHeight) + 'px';
            });
        });

        function showView(viewToShow) {
            [elements.placeholderView, elements.chatView, elements.settingsView].forEach(view => view.classList.add('hidden'));
            viewToShow.classList.remove('hidden');

            if (IS_MOBILE) {
                elements.mainContent.classList.add('visible');
            }
        }

        function showThreadsViewOnMobile() {
            if (IS_MOBILE) {
                elements.mainContent.classList.remove('visible');
                document.querySelectorAll('.thread-item.active').forEach(el => el.classList.remove('active'));
                currentThreadId = null;
            }
        }

        const advertCache = new Map();
        async function getAdvert(id) {
            if (!id) return null;
            if (advertCache.has(id)) return advertCache.get(id);
            const lsKey = `advert_${id}`;
            const cached = localStorage.getItem(lsKey);
            if (cached) {
                const advert = JSON.parse(cached);
                advertCache.set(id, advert);
                return advert;
            }
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/adverts/${id}`);
                if (!response.ok) return null;
                const advert = await response.json();
                advertCache.set(id, advert);
                localStorage.setItem(lsKey, JSON.stringify(advert));
                return advert;
            } catch (err) {
                return null;
            }
        }

        async function fetchThreads() {
            elements.loader.classList.remove('hidden');
            elements.threadsList.innerHTML = '';
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/threads`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`${errorData.error} <a href="${AUTH_URL}">–û—Ç–æ—Ä–∏–∑–∏—Ä–∞–π—Ç–µ —Å–µ –æ—Ç–Ω–æ–≤–æ</a>.`);
                }
                const threads = await response.json();
                if (!threads || threads.length === 0) {
                    elements.threadsList.innerHTML = '<p style="padding: 15px;">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏.</p>';
                    return;
                }

                for (const thread of threads) {
                    // ‚úÖ –ü–†–û–ú–Ø–ù–ê: –î–æ–±–∞–≤–µ–Ω try-catch, –∑–∞ –¥–∞ –Ω–µ —Å–ø–∏—Ä–∞ —Ü–µ–ª–∏—è—Ç —Å–ø–∏—Å—ä–∫ –ø—Ä–∏ –≥—Ä–µ—à–∫–∞ –≤ –µ–¥–∏–Ω —Ä–∞–∑–≥–æ–≤–æ—Ä.
                    try {
                        let advertTitle = '';
                        if (thread.advert_id) {
                           const advert = await getAdvert(thread.advert_id);
                            if (advert && advert.data) {
                                advertTitle = advert.data.title;
                            }
                        }

                        const threadElement = document.createElement('div');
                        threadElement.className = 'thread-item';
                        threadElement.dataset.threadId = thread.id;
                        if (thread.unread_count > 0) threadElement.classList.add('unread');

                        const lastDate = formatDate(thread.last_message_date);
                        const interlocutorName = thread.interlocutor?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª';

                        threadElement.innerHTML = `
                            <input type="checkbox" class="thread-checkbox" data-id="${thread.id}">
                            <div class="thread-item-info">
                                <p class="user-name">${interlocutorName}</p>
                                <small class="advert-title">${advertTitle}</small>
                                <small>–ü–æ—Å–ª–µ–¥–Ω–æ: ${lastDate}</small>
                            </div>
                        `;

                        threadElement.addEventListener('click', () => {
                            document.querySelectorAll('.thread-item.active').forEach(el => el.classList.remove('active'));
                            threadElement.classList.add('active');
                            displayMessages(thread.id, interlocutorName);
                        });

                        elements.threadsList.appendChild(threadElement);
                    } catch (e) {
                        console.error(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä ID ${thread.id}:`, e);
                    }
                }
            } catch (error) {
                elements.threadsList.innerHTML = `<p style="color: red; padding: 15px;">${error.message}</p>`;
            } finally {
                elements.loader.classList.add('hidden');
            }
        }

        async function displayMessages(threadId, interlocutorName = '') {
            currentThreadId = threadId;
            elements.chatPartnerName.textContent = interlocutorName;
            showView(elements.chatView);
            elements.messagesView.innerHTML = '<div id="messages-loader">–ó–∞—Ä–µ–∂–¥–∞–º —Å—ä–æ–±—â–µ–Ω–∏—è—Ç–∞...</div>';
            elements.analyzerResult.classList.add('hidden');
            elements.analyzerInput.value = '';

            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/threads/${threadId}/messages`);
                if (!response.ok) throw new Error('–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏—è—Ç–∞.');
                
                const messages = await response.json();
                elements.messagesView.innerHTML = '<div id="messages-container"></div>';
                const container = document.getElementById('messages-container');
                
                if (!messages || messages.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color: #888;">–ù—è–º–∞ —Å—ä–æ–±—â–µ–Ω–∏—è –≤ —Ç–æ–∑–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä.</p>';
                } else {
                    messages.forEach(msg => {
                        const msgElement = document.createElement('div');
                        msgElement.className = `message ${msg.type}`;
                        msgElement.textContent = msg.text;
                        container.appendChild(msgElement);
                    });
                    elements.messagesView.scrollTop = elements.messagesView.scrollHeight;
                }
            } catch (error) {
                elements.messagesView.innerHTML = `<p class="error">${error.message}</p>`;
            }
        }

        async function sendMessage() {
            if (!currentThreadId) return;
            const text = elements.replyText.value.trim();
            if (!text) return;

            setButtonLoading(elements.sendButton, true, '...');
            try {
                await authorizedFetch(`${API_BASE_URL}/api/threads/${currentThreadId}/send-message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                elements.replyText.value = '';
                elements.replyText.style.height = 'auto'; // Reset height
                await displayMessages(currentThreadId, elements.chatPartnerName.textContent);
            } catch (error) {
                alert(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ: ${error.message}`);
            } finally {
                setButtonLoading(elements.sendButton, false, '<span>–ò–∑–ø—Ä–∞—Ç–∏</span>');
            }
        }

        async function generateAiReply() {
            if (!currentThreadId) return;
            setButtonLoading(elements.generateAiButton, true, '...');
            elements.replyText.value = 'AI –≥–µ–Ω–µ—Ä–∏—Ä–∞ –æ—Ç–≥–æ–≤–æ—Ä, –º–æ–ª—è –∏–∑—á–∞–∫–∞–π—Ç–µ...';

            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/generate-reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threadId: currentThreadId })
                });
                if (!response.ok) throw new Error((await response.json()).error);
                
                const data = await response.json();
                elements.replyText.value = data.reply;
                elements.replyText.dispatchEvent(new Event('input')); // Trigger auto-resize
            } catch (error) {
                elements.replyText.value = `–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ: ${error.message}`;
            } finally {
                setButtonLoading(elements.generateAiButton, false, '‚ú®');
            }
        }

        async function analyzeThread() {
             if (!currentThreadId) return;
            const question = elements.analyzerInput.value.trim();
            if (!question) return alert('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤—ä–ø—Ä–æ—Å.');

            setButtonLoading(elements.analyzerButton, true, '...');
            elements.analyzerResult.classList.remove('hidden');
            elements.analyzerResult.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–º...';

            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/analyze-thread`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threadId: currentThreadId, question })
                });
                if (!response.ok) throw new Error((await response.json()).error);

                const data = await response.json();
                elements.analyzerResult.textContent = data.answer;
            } catch (error) {
                elements.analyzerResult.textContent = `–ì—Ä–µ—à–∫–∞: ${error.message}`;
            } finally {
                setButtonLoading(elements.analyzerButton, false, '–ü–∏—Ç–∞–π AI');
            }
        }

        function handleSelectAll() {
            document.querySelectorAll('.thread-checkbox').forEach(cb => cb.checked = elements.selectAllCheckbox.checked);
            updateBroadcastCounter();
        }

        function updateBroadcastCounter() {
            const selectedCount = document.querySelectorAll('.thread-checkbox:checked').length;
            elements.broadcastSection.classList.toggle('hidden', selectedCount === 0);
            elements.broadcastButton.disabled = selectedCount === 0;
            elements.broadcastButton.textContent = `–ò–∑–ø—Ä–∞—Ç–∏ –Ω–∞ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ (${selectedCount})`;
        }

        async function sendBroadcastMessage() {
            const message = elements.broadcastMessage.value.trim();
            if (!message) return;
            const selectedIds = Array.from(document.querySelectorAll('.thread-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0 || !confirm(`–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑–ø—Ä–∞—Ç–∏—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏–µ –¥–æ ${selectedIds.length} –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏?`)) return;

            setButtonLoading(elements.broadcastButton, true, '–ò–∑–ø—Ä–∞—â–∞–º...');
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/broadcast`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threadIds: selectedIds, text: message })
                });
                if (!response.ok) throw new Error((await response.json()).error);
                const data = await response.json();
                alert(`–°—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ –¥–æ ${data.sentCount} –æ—Ç ${selectedIds.length} –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏.`);
                elements.broadcastMessage.value = '';
            } catch (error) {
                alert(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥—Ä—É–ø–æ–≤–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ: ${error.message}`);
            } finally {
                setButtonLoading(elements.broadcastButton, false, `–ò–∑–ø—Ä–∞—Ç–∏ –Ω–∞ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ (${selectedIds.length})`);
            }
        }

        async function showSettingsView() {
            showView(elements.settingsView);
            elements.statusMessage.textContent = '';
            elements.promptTextarea.value = '–ó–∞—Ä–µ–∂–¥–∞–º...';
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/prompt`);
                if (!response.ok) throw new Error((await response.json()).error);
                const data = await response.json();
                elements.promptTextarea.value = data.prompt || '';
            } catch (error) {
                elements.promptTextarea.value = `–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ: ${error.message}`;
            }
        }

        async function savePrompt() {
            const newPrompt = elements.promptTextarea.value;
            setButtonLoading(elements.savePromptButton, true, '–ó–∞–ø–∞–∑–≤–∞–º...');
            showStatusMessage('–ó–∞–ø–∞–∑–≤–∞–º...');
            try {
                await authorizedFetch(`${API_BASE_URL}/api/prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: newPrompt })
                });
                showStatusMessage('–ü—Ä–æ–º–ø—Ç—ä—Ç –µ –∑–∞–ø–∞–∑–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
            } catch (error) {
                showStatusMessage(`–ì—Ä–µ—à–∫–∞: ${error.message}`, 'error');
            } finally {
                setButtonLoading(elements.savePromptButton, false, '–ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–ø—Ç–∞');
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '---';
            const d = new Date(dateStr);
            return isNaN(d) ? '---' : d.toLocaleString('bg-BG', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
        }

        function setButtonLoading(button, isLoading, loadingText) {
            button.disabled = isLoading;
            if (isLoading) {
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = loadingText;
            } else {
                button.innerHTML = button.dataset.originalText || 'Submit';
            }
        }

        function showStatusMessage(message, type = '') {
            elements.statusMessage.textContent = message;
            elements.statusMessage.className = `status-message ${type}`;
        }
    </script>
</body>
</html>
