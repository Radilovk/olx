<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OLX Command Center</title>
    <style>
        /* --- General Layout --- */
        :root { --main-blue: #007bff; --light-blue: #e0eafc; --ai-purple: #563d7c; --gray-bg: #f4f4f5; --light-gray: #e9e9eb; --text-dark: #111; --text-light: #555; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; margin: 0; height: 100vh; background-color: var(--gray-bg); font-size: 14px; }
        * { box-sizing: border-box; }

        /* --- Sidebar --- */
        #sidebar { width: 350px; border-right: 1px solid #ccc; height: 100%; display: flex; flex-direction: column; background-color: #fff; }
        .sidebar-header { padding: 10px 15px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { margin: 0; font-size: 1.2em; color: #333; }
        .sidebar-controls { display: flex; align-items: center; font-size: 12px; }
        .sidebar-controls label { margin-right: 10px; }
        .sidebar-controls button { background: none; border: 1px solid #ccc; cursor: pointer; border-radius: 5px; padding: 5px 8px; }
        #threads-list { flex-grow: 1; overflow-y: auto; }
        
        /* --- Broadcast (Group Message) Section --- */
        #broadcast-section { padding: 10px; border-top: 1px solid #ccc; }
        #broadcast-section textarea { width: 100%; resize: vertical; padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 5px; }
        #broadcast-section button { width: 100%; padding: 10px; background-color: var(--ai-purple); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        #broadcast-section button:disabled { background-color: #ccc; }

        /* --- Thread Item in Sidebar --- */
        .thread-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: flex-start; }
        .thread-item:hover { background-color: #f0f0f0; }
        .thread-item.active { background-color: var(--light-blue); border-right: 3px solid var(--main-blue); }
        .thread-item input[type="checkbox"] { margin-right: 10px; }
        .thread-item-info { flex-grow: 1; }
        .thread-item-info p, .thread-item-info small { margin: 0; color: var(--text-light); }
        .thread-item-info p { font-weight: 500; color: var(--text-dark); display: flex; justify-content: space-between; align-items: center; }
        .thread-item-info .short-ad-name { margin-left: 5px; flex-grow: 1; border: 0; border-bottom: 1px dashed #ccc; background: transparent; font-size: 12px; }
        .thread-item-info .short-ad-name:focus { outline: none; border-bottom-color: var(--main-blue); }
        .thread-item.unread p { font-weight: bold; }
        .note-button { background: none; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; padding: 2px 4px; }
        .tag-buttons { display: flex; gap: 4px; margin-top: 4px; }
        .tag-buttons .tag-btn { width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f9fa; cursor: pointer; font-size: 12px; line-height: 18px; text-align: center; padding: 0; }
        .tag-buttons .tag-btn.red { background-color: #f8d7da; }
        .tag-buttons .tag-btn.red.active { background-color: #dc3545; color: #fff; }
        .tag-buttons .tag-btn.blue { background-color: #d1ecf1; }
        .tag-buttons .tag-btn.blue.active { background-color: #0d6efd; color: #fff; }
        .tag-buttons .tag-btn.check.active { background-color: #d4edda; }
        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:1000; }
        #modal-overlay.hidden { display:none; }
        #modal { background:#fff; padding:20px; border-radius:5px; width:300px; }
        #modal-body input, #modal-body textarea { width:100%; margin-bottom:10px; }
        #modal .modal-actions { text-align:right; }
        #modal .modal-actions button { margin-left:5px; }
        #back-button { display: none; margin: 5px; padding: 5px 10px; border: 1px solid #ccc; background: none; border-radius: 5px; cursor: pointer; }

        /* --- Main Content Area --- */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100%; }
        #content-area { flex-grow: 1; display: flex; flex-direction: column; }
        .placeholder { text-align: center; color: #888; margin: auto; }
        
        /* --- AI Analyzer Section --- */
        #analyzer-section { padding: 15px; border-bottom: 1px solid #ccc; background-color: #fafafa; }
        #analyzer-section p { margin: 0 0 10px 0; font-weight: bold; }
        .analyzer-input-group { display: flex; }
        #analyzer-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 5px; padding: 8px; }
        #analyzer-button { margin-left: 10px; background-color: var(--ai-purple); color: white; border:none; border-radius:5px; padding: 0 15px; font-weight: bold; cursor: pointer; }
        #analyzer-result { margin-top: 10px; padding: 10px; background-color: #eef; border-radius: 5px; color: #333; }

        /* --- Messages View --- */
        #messages-view { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 18px; max-width: 70%; word-wrap: break-word; line-height: 1.4; }
        .message.sent { background-color: var(--main-blue); color: white; align-self: flex-end; }
        .message.received { background-color: var(--light-gray); color: black; align-self: flex-start; }
        #messages-container { display: flex; flex-direction: column; }

        /* --- Reply Area --- */
        #reply-area { border-top: 1px solid #ccc; padding: 10px; display: flex; background-color: #f9f9f9; align-items: center; }
        #reply-area textarea { flex-grow: 1; resize: none; border-radius: 18px; border: 1px solid #ccc; padding: 10px; font-size: 14px; line-height: 1.4; }
        #reply-area button { margin-left: 10px; padding: 0 20px; height: 38px; border-radius: 18px; border: none; font-weight: bold; cursor: pointer; transition: background-color 0.2s; white-space: nowrap; }
        #reply-area button#send-button { background-color: var(--main-blue); color: white; }
        #reply-area button#generate-ai-button { background-color: var(--ai-purple); color: white; }
        #reply-area button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- Settings View --- */
        #settings-view { padding: 20px; }
        #settings-view h2 { margin-top: 0; }
        #settings-view textarea { width: 100%; height: 200px; resize: vertical; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #settings-view button { padding: 10px 20px; background-color: var(--main-blue); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #status-message { margin-top: 10px; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }

        /* --- General Helpers --- */
        .hidden { display: none !important; }
        #loader, #messages-loader { text-align: center; padding: 20px; color: #888; }

        /* --- Responsive Layout --- */
        @media (max-width: 600px) {
            body { flex-direction: column; height: 100vh; font-size: 16px; }
            #sidebar, #main-content { width: 100%; height: 100%; }
            #sidebar { border-right: none; border-bottom: none; }
            #back-button { display: block; }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR: –°–ø–∏—Å—ä–∫ —Å —Ä–∞–∑–≥–æ–≤–æ—Ä–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–∞ –≥—Ä—É–ø–æ–≤–∏ —Å—ä–æ–±—â–µ–Ω–∏—è -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h2>–†–∞–∑–≥–æ–≤–æ—Ä–∏</h2>
            <div class="sidebar-controls">
                <label><input type="checkbox" id="select-all-checkbox"> –í—Å–∏—á–∫–∏</label>
                <button id="refresh-button">üîÑ</button>
                <button id="settings-button" style="margin-left: 5px;">‚öôÔ∏è</button>
            </div>
        </div>
        <div id="loader">–ó–∞—Ä–µ–∂–¥–∞–º —Ä–∞–∑–≥–æ–≤–æ—Ä–∏...</div>
        <div id="threads-list"></div>
        <div id="broadcast-section" class="hidden">
            <textarea id="broadcast-message" rows="4" placeholder="–ù–∞–ø–∏—à–µ—Ç–µ –≥—Ä—É–ø–æ–≤–æ —Å—ä–æ–±—â–µ–Ω–∏–µ..."></textarea>
            <button id="broadcast-button" disabled>–ò–∑–ø—Ä–∞—Ç–∏ –Ω–∞ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ (0)</button>
        </div>
    </div>

    <!-- MAIN CONTENT: –ú—è—Å—Ç–æ –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —á–∞—Ç, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¥—Ä. -->
    <div id="main-content">
        <div id="content-area">
            <!-- –ù–∞—á–∞–ª–µ–Ω –∏–∑–≥–ª–µ–¥ -->
            <div id="placeholder-view" class="placeholder">
                <h1>OLX Command Center</h1>
                <p>–ò–∑–±–µ—Ä–µ—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä –æ—Ç–ª—è–≤–æ, –∑–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—Ç–µ.</p>
            </div>

            <!-- –ò–∑–≥–ª–µ–¥ –∑–∞ —á–∞—Ç -->
            <div id="chat-view" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                <button id="back-button" class="hidden">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
                <div id="analyzer-section">
                    <p>AI –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞</p>
                    <div class="analyzer-input-group">
                        <input type="text" id="analyzer-input" placeholder="–ù–∞–ø—Ä. '–ö–∞–∫—ä–≤ –µ –∞–¥—Ä–µ—Å—ä—Ç –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞?'">
                        <button id="analyzer-button">–ü–∏—Ç–∞–π AI</button>
                    </div>
                    <div id="analyzer-result" class="hidden"></div>
                </div>
                <div id="chat-tags" class="tag-buttons"></div>
                <div id="messages-view"></div>
                <div id="reply-area">
                    <textarea id="reply-text" rows="3" placeholder="–ù–∞–ø–∏—à–µ—Ç–µ –æ—Ç–≥–æ–≤–æ—Ä..."></textarea>
                    <button id="send-button">–ò–∑–ø—Ä–∞—Ç–∏</button>
                    <button id="generate-ai-button" class="ai-button">‚ú® –ì–µ–Ω–µ—Ä–∏—Ä–∞–π</button>
                </div>
            </div>

            <!-- –ò–∑–≥–ª–µ–¥ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div id="settings-view" class="hidden">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ AI –ê—Å–∏—Å—Ç–µ–Ω—Ç–∞</h2>
                <p>–¢—É–∫ –º–æ–∂–µ—Ç–µ –¥–∞ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–∏—è –ø—Ä–æ–º–ø—Ç, –∫–æ–π—Ç–æ AI –∏–∑–ø–æ–ª–∑–≤–∞, –∑–∞ –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏. –û–ø–∏—à–µ—Ç–µ –∫–∞–∫–≤–∞ —Ä–æ–ª—è –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–≥—Ä–∞–µ, –∫–∞–∫—ä–≤ —Ç–æ–Ω –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞ –∏ —Ç.–Ω.</p>
                <textarea id="prompt-textarea"></textarea>
                <button id="save-prompt-button">–ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–ø—Ç–∞</button>
                <div id="status-message"></div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden">
        <div id="modal">
            <h3 id="modal-title"></h3>
            <div id="modal-body"></div>
            <div class="modal-actions">
                <button id="modal-save">–ó–∞–ø–∞–∑–∏</button>
                <button id="modal-close">–ó–∞—Ç–≤–æ—Ä–∏</button>
            </div>
        </div>
    </div>
    <script src="auth.js"></script>
    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = 'https://olx.radilov-k.workers.dev';
        const AUTH_URL = 'https://www.olx.bg/oauth/authorize?response_type=code&client_id=200383&redirect_uri=https://olx.radilov-k.workers.dev/callback&scope=read+write+v2&state=random_string_12345';
        
        // --- STATE ---
        let currentThreadId = null;

        // --- DOM ELEMENTS ---
        const elements = {
            sidebar: document.getElementById('sidebar'),
            loader: document.getElementById('loader'),
            threadsList: document.getElementById('threads-list'),
            selectAllCheckbox: document.getElementById('select-all-checkbox'),
            refreshButton: document.getElementById('refresh-button'),
            settingsButton: document.getElementById('settings-button'),
            broadcastSection: document.getElementById('broadcast-section'),
            broadcastMessage: document.getElementById('broadcast-message'),
            broadcastButton: document.getElementById('broadcast-button'),
            placeholderView: document.getElementById('placeholder-view'),
            chatView: document.getElementById('chat-view'),
            settingsView: document.getElementById('settings-view'),
            messagesView: document.getElementById('messages-view'),
            replyText: document.getElementById('reply-text'),
            sendButton: document.getElementById('send-button'),
            generateAiButton: document.getElementById('generate-ai-button'),
            analyzerInput: document.getElementById('analyzer-input'),
            analyzerButton: document.getElementById('analyzer-button'),
            analyzerResult: document.getElementById('analyzer-result'),
            promptTextarea: document.getElementById('prompt-textarea'),
            savePromptButton: document.getElementById('save-prompt-button'),
            statusMessage: document.getElementById('status-message'),
            mainContent: document.getElementById('main-content'),
            backButton: document.getElementById('back-button'),
        };

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchThreads();

            if (isMobile()) {
                elements.mainContent.classList.add('hidden');
            }

            elements.refreshButton.addEventListener('click', fetchThreads);
            elements.settingsButton.addEventListener('click', showSettingsView);
            elements.selectAllCheckbox.addEventListener('change', handleSelectAll);
            elements.threadsList.addEventListener('change', e => {
                if (e.target.classList.contains('thread-checkbox')) updateBroadcastCounter();
            });

            elements.sendButton.addEventListener('click', sendMessage);
            elements.generateAiButton.addEventListener('click', generateAiReply);
            elements.analyzerButton.addEventListener('click', analyzeThread);
            elements.broadcastButton.addEventListener('click', sendBroadcastMessage);
            elements.savePromptButton.addEventListener('click', savePrompt);
            elements.backButton.addEventListener('click', showSidebarOnMobile);
        });

        // --- VIEW MANAGEMENT ---
        function showView(viewToShow) {
            [elements.placeholderView, elements.chatView, elements.settingsView].forEach(view => {
                view.classList.add('hidden');
            });
            viewToShow.classList.remove('hidden');
        }

        function isMobile() {
            return window.innerWidth <= 600;
        }

        function showThreadOnMobile() {
            if (isMobile()) {
                elements.sidebar.classList.add('hidden');
                elements.mainContent.classList.remove('hidden');
                elements.backButton.classList.remove('hidden');
            }
        }

        function showSidebarOnMobile() {
            if (isMobile()) {
                elements.sidebar.classList.remove('hidden');
                elements.mainContent.classList.add('hidden');
                elements.backButton.classList.add('hidden');
                showView(elements.placeholderView);
            }
        }

        // --- CORE FUNCTIONS ---

        const advertCache = new Map();

        async function getAdvert(id) {
            if (!id) return null;
            if (advertCache.has(id)) return advertCache.get(id);
            const lsKey = `advert_${id}`;
            const cached = localStorage.getItem(lsKey);
            if (cached) {
                const advert = JSON.parse(cached);
                advertCache.set(id, advert);
                return advert;
            }
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/adverts/${id}`);
                if (!response.ok) throw new Error('Advert fetch failed');
                const advert = await response.json();
                advertCache.set(id, advert);
                localStorage.setItem(lsKey, JSON.stringify(advert));
                return advert;
            } catch (err) {
                return null; // –æ—Ç–∫–∞–∑ –æ—Ç API
            }
        }

        async function fetchThreads() {
            elements.loader.classList.remove('hidden');
            elements.threadsList.innerHTML = '';
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/threads`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`${errorData.error} <a href="${AUTH_URL}">–û—Ç–æ—Ä–∏–∑–∏—Ä–∞–π—Ç–µ —Å–µ –æ—Ç–Ω–æ–≤–æ</a>.`);
                }
                const threads = await response.json();
                if (!threads || threads.length === 0) {
                    elements.threadsList.innerHTML = '<p style="padding: 15px;">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏.</p>';
                    return;
                }

                for (const thread of threads) {
                    const meta = getThreadMeta(thread.id);
                    if (thread.advert_id) {
                        try {
                            const advert = await getAdvert(thread.advert_id);
                            if (advert && advert.data) {
                                meta.advertTitle = advert.data.title || meta.advertTitle;
                                meta.advertCreatedAt = advert.data.created_at || meta.advertCreatedAt;
                            } else {
                                meta.advertTitle = meta.advertTitle || '(–Ω–µ–≤–∞–ª–∏–¥–Ω–∞ –æ–±—è–≤–∞)';
                            }
                        } catch (err) {
                            meta.advertTitle = meta.advertTitle || '(–Ω–µ–≤–∞–ª–∏–¥–Ω–∞ –æ–±—è–≤–∞)';
                        }
                        saveThreadMeta(thread.id, meta);
                    }

                    const threadElement = document.createElement('div');
                    threadElement.className = 'thread-item';
                    threadElement.dataset.threadId = thread.id;

                    const isRead = thread.unread_count === 0;
                    const shortValue = meta.shortName || meta.advertTitle || '';
                    const lastDateRaw = meta.lastDate || thread.last_message_date || thread.last_message?.created_at || thread.last_message?.date || thread.updated_at;
                    const lastDate = formatDate(lastDateRaw);
                    if (!isRead) threadElement.classList.add('unread');

                    const conversationId = thread.id;
                    const advertTitle = meta.advertTitle || '';

                    threadElement.innerHTML = `
                        <input type="checkbox" class="thread-checkbox" data-id="${thread.id}" name="thread-checkbox-${thread.id}">
                        <div class="thread-item-info">
                            <p><span class="conversation-id">${conversationId}</span><input class="short-ad-name" name="short-ad-name-${thread.id}" value="${shortValue}" placeholder="${advertTitle || '–ö—Ä–∞—Ç–∫–æ –∏–º–µ'}"></p>
                            <small class="advert-title">${advertTitle}</small>
                            <small class="last-date">–ü–æ—Å–ª–µ–¥–Ω–æ: ${lastDate}</small>
                        </div>
                        <div class="tag-buttons">${createTagButtons(meta)}</div>
                    `;

                    const info = threadElement.querySelector('.thread-item-info');
                    const tagContainer = threadElement.querySelector('.tag-buttons');
                    attachTagButtonEvents(tagContainer, meta, thread.id);
                    info.addEventListener('click', () => {
                        document.querySelectorAll('.thread-item').forEach(el => el.classList.remove('active'));
                        threadElement.classList.add('active');
                        displayMessages(thread.id);
                        showThreadOnMobile();
                    });

                    const shortInput = threadElement.querySelector('.short-ad-name');
                    shortInput.addEventListener('change', e => {
                        e.stopPropagation();
                        meta.shortName = e.target.value.trim();
                        saveThreadMeta(thread.id, meta);
                    });

                    refreshThreadDetails(thread.id, threadElement, meta, shortInput);

                    elements.threadsList.appendChild(threadElement);
                }
            } catch (error) {
                elements.threadsList.innerHTML = `<p style="color: red; padding: 15px;">${error.message}</p>`;
            } finally {
                elements.loader.classList.add('hidden');
            }
        }

        async function refreshThreadDetails(id, threadElement, meta, shortInput) {
            const advertEl = threadElement.querySelector('.advert-title');
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/threads/${id}/details`);
                if (!response.ok) throw new Error('fetch failed');
                const data = await response.json();
                meta.advertTitle = data.advertTitle || '';
                meta.lastDate = data.lastMessageDate || meta.lastDate;
                saveThreadMeta(id, meta);
                advertEl.textContent = meta.advertTitle;
                const dateEl = threadElement.querySelector('.last-date');
                if (dateEl) dateEl.textContent = `–ü–æ—Å–ª–µ–¥–Ω–æ: ${formatDate(meta.lastDate)}`;
                if (!meta.shortName) {
                    shortInput.placeholder = meta.advertTitle || '–ö—Ä–∞—Ç–∫–æ –∏–º–µ';
                }
            } catch (err) {
                advertEl.textContent = meta.advertTitle || advertEl.textContent;
            }
        }

        async function displayMessages(threadId) {
            currentThreadId = threadId;
            showView(elements.chatView);
            renderChatTags(threadId);
            elements.messagesView.innerHTML = '<div id="messages-loader">–ó–∞—Ä–µ–∂–¥–∞–º —Å—ä–æ–±—â–µ–Ω–∏—è—Ç–∞...</div>';
            elements.analyzerResult.classList.add('hidden');
            elements.analyzerInput.value = '';

            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/threads/${threadId}/messages`);
                if (!response.ok) throw new Error('–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏—è—Ç–∞.');
                
                const messages = await response.json();
                elements.messagesView.innerHTML = '<div id="messages-container"></div>';
                const container = document.getElementById('messages-container');

                if (!messages || messages.length === 0) {
                    container.innerHTML = '<p>–ù—è–º–∞ —Å—ä–æ–±—â–µ–Ω–∏—è –≤ —Ç–æ–∑–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä.</p>';
                } else {
                    messages.forEach(msg => {
                        const msgElement = document.createElement('div');
                        msgElement.className = `message ${msg.type}`;
                        msgElement.textContent = msg.text;
                        container.appendChild(msgElement);
                    });
                    elements.messagesView.scrollTop = elements.messagesView.scrollHeight;

                    const meta = getThreadMeta(threadId);
                    const lastMsg = messages[messages.length - 1];
                    meta.lastDate = lastMsg?.created_at || lastMsg?.date || meta.lastDate;
                    const clientMsg = messages.find(m => m.type === 'received') ||
                        messages.find(m => m.type !== 'sent') ||
                        messages[0];
                    if (clientMsg) {
                        meta.contactName = clientMsg.user_name || clientMsg.user?.name || clientMsg.sender?.name || meta.contactName;
                    }
                    saveThreadMeta(threadId, meta);
                    renderChatTags(threadId);
                    const threadEl = document.querySelector(`.thread-item[data-thread-id="${threadId}"]`);
                    if (threadEl) {
                        const dateEl = threadEl.querySelector('.last-date');
                        if (dateEl) dateEl.textContent = `–ü–æ—Å–ª–µ–¥–Ω–æ: ${formatDate(meta.lastDate)}`;
                    }
                }
            } catch (error) {
                elements.messagesView.innerHTML = `<p class="error">${error.message}</p>`;
            }
        }

        async function sendMessage() {
            if (!currentThreadId) return;
            const text = elements.replyText.value.trim();
            if (!text) return;

            elements.sendButton.disabled = true;
            elements.sendButton.textContent = '...';

            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/threads/${currentThreadId}/send-message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                if (!response.ok) throw new Error((await response.json()).error);
                
                elements.replyText.value = '';
                setTimeout(() => displayMessages(currentThreadId), 1000);
            } catch (error) {
                alert(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ: ${error.message}`);
            } finally {
                elements.sendButton.disabled = false;
                elements.sendButton.textContent = '–ò–∑–ø—Ä–∞—Ç–∏';
            }
        }

        async function generateAiReply() {
            if (!currentThreadId) return;
            setButtonLoading(elements.generateAiButton, true, '–ú–∏—Å–ª–∏...');
            elements.replyText.value = 'AI –≥–µ–Ω–µ—Ä–∏—Ä–∞ –æ—Ç–≥–æ–≤–æ—Ä, –º–æ–ª—è –∏–∑—á–∞–∫–∞–π—Ç–µ...';

            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/generate-reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threadId: currentThreadId })
                });
                if (!response.ok) throw new Error((await response.json()).error);
                
                const data = await response.json();
                elements.replyText.value = data.reply;
            } catch (error) {
                elements.replyText.value = `–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ: ${error.message}`;
            } finally {
                setButtonLoading(elements.generateAiButton, false, '‚ú® –ì–µ–Ω–µ—Ä–∏—Ä–∞–π');
            }
        }

        async function analyzeThread() {
            if (!currentThreadId) return;
            const question = elements.analyzerInput.value.trim();
            if (!question) return alert('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤—ä–ø—Ä–æ—Å.');

            setButtonLoading(elements.analyzerButton, true, '...');
            elements.analyzerResult.classList.remove('hidden');
            elements.analyzerResult.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–º...';

            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/analyze-thread`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threadId: currentThreadId, question })
                });
                if (!response.ok) throw new Error((await response.json()).error);

                const data = await response.json();
                elements.analyzerResult.textContent = data.answer;
            } catch (error) {
                elements.analyzerResult.textContent = `–ì—Ä–µ—à–∫–∞: ${error.message}`;
            } finally {
                setButtonLoading(elements.analyzerButton, false, '–ü–∏—Ç–∞–π AI');
            }
        }

        // --- BROADCAST FUNCTIONS ---
        function handleSelectAll() {
            const isChecked = elements.selectAllCheckbox.checked;
            document.querySelectorAll('.thread-checkbox').forEach(cb => cb.checked = isChecked);
            updateBroadcastCounter();
        }

        function updateBroadcastCounter() {
            const selectedCount = elements.threadsList.querySelectorAll('.thread-checkbox:checked').length;
            elements.broadcastSection.classList.toggle('hidden', selectedCount === 0);
            elements.broadcastButton.disabled = selectedCount === 0;
            elements.broadcastButton.textContent = `–ò–∑–ø—Ä–∞—Ç–∏ –Ω–∞ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ (${selectedCount})`;
        }

        async function sendBroadcastMessage() {
            const message = elements.broadcastMessage.value.trim();
            if (!message) return alert('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –≥—Ä—É–ø–æ–≤–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ.');
            
            const selectedIds = Array.from(document.querySelectorAll('.thread-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) return;

            if (!confirm(`–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑–ø—Ä–∞—Ç–∏—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏–µ –¥–æ ${selectedIds.length} –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏?`)) return;

            setButtonLoading(elements.broadcastButton, true, '–ò–∑–ø—Ä–∞—â–∞–º...');
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/broadcast`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threadIds: selectedIds, text: message })
                });
                if (!response.ok) throw new Error((await response.json()).error);

                const data = await response.json();
                alert(`–°—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ –¥–æ ${data.sentCount} –æ—Ç ${selectedIds.length} –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏.`);
                elements.broadcastMessage.value = '';
            } catch (error) {
                alert(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥—Ä—É–ø–æ–≤–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ: ${error.message}`);
            } finally {
                setButtonLoading(elements.broadcastButton, false, `–ò–∑–ø—Ä–∞—Ç–∏ –Ω–∞ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ (${selectedIds.length})`);
            }
        }

        // --- TAG BUTTONS FUNCTIONS ---
        function createTagButtons(meta = {}) {
            return `
                <button class="tag-btn red ${meta.redMark ? 'active' : ''}" title="–ß–µ—Ä–≤–µ–Ω–æ"></button>
                <button class="tag-btn blue ${meta.blueMark ? 'active' : ''}" title="–°–∏–Ω—å–æ"></button>
                <button class="tag-btn check ${meta.checked ? 'active' : ''}" title="–û—Ç–º–µ—Ç–∫–∞">${meta.checked ? '‚úì' : ''}</button>
                <button class="tag-btn info" title="–î–∞–Ω–Ω–∏">i</button>
                <button class="tag-btn note" title="–ë–µ–ª–µ–∂–∫–∞">@</button>
            `;
        }

        function attachTagButtonEvents(container, meta, threadId) {
            const redBtn = container.querySelector('.red');
            const blueBtn = container.querySelector('.blue');
            const checkBtn = container.querySelector('.check');
            const infoBtn = container.querySelector('.info');
            const noteBtn = container.querySelector('.note');

            redBtn.addEventListener('click', e => {
                e.stopPropagation();
                meta.redMark = !meta.redMark;
                saveThreadMeta(threadId, meta);
                updateThreadTagButtons(threadId);
            });

            blueBtn.addEventListener('click', e => {
                e.stopPropagation();
                meta.blueMark = !meta.blueMark;
                saveThreadMeta(threadId, meta);
                updateThreadTagButtons(threadId);
            });

            checkBtn.addEventListener('click', e => {
                e.stopPropagation();
                meta.checked = !meta.checked;
                saveThreadMeta(threadId, meta);
                updateThreadTagButtons(threadId);
            });

            infoBtn.addEventListener('click', e => {
                e.stopPropagation();
                openInfoModal(threadId);
            });

            noteBtn.addEventListener('click', e => {
                e.stopPropagation();
                openNoteModal(threadId);
            });
        }

        function updateThreadTagButtons(threadId) {
            const meta = getThreadMeta(threadId);
            const threadEl = document.querySelector(`.thread-item[data-thread-id="${threadId}"]`);
            if (threadEl) {
                const tagContainer = threadEl.querySelector('.tag-buttons');
                if (tagContainer) {
                    tagContainer.innerHTML = createTagButtons(meta);
                    attachTagButtonEvents(tagContainer, meta, threadId);
                }
            }
            if (currentThreadId === threadId) {
                renderChatTags(threadId);
            }
        }

        function renderChatTags(threadId) {
            const container = document.getElementById('chat-tags');
            if (!container) return;
            const meta = getThreadMeta(threadId);
            container.innerHTML = createTagButtons(meta);
            attachTagButtonEvents(container, meta, threadId);
        }

        async function openInfoModal(threadId) {
            const meta = getThreadMeta(threadId);
            let info = meta.deliveryInfo || {};
            if (!info.name && !info.phone && !info.address) {
                try {
                    const response = await authorizedFetch(`${API_BASE_URL}/api/analyze-thread`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ threadId, question: '–ò–∑–≤–ª–µ—á–∏ –∏–º–µ–Ω–∞—Ç–∞, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –∞–¥—Ä–µ—Å–∞ –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞. –§–æ—Ä–º–∞—Ç: Name: <...>; Phone: <...>; Address: <...>' })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const answer = data.answer || '';
                        const nameMatch = answer.match(/Name[:\-]?\s*(.*)/i);
                        const phoneMatch = answer.match(/Phone[:\-]?\s*(.*)/i);
                        const addressMatch = answer.match(/Address[:\-]?\s*(.*)/i);
                        info = {
                            name: nameMatch ? nameMatch[1].trim() : '',
                            phone: phoneMatch ? phoneMatch[1].trim() : '',
                            address: addressMatch ? addressMatch[1].trim() : ''
                        };
                    }
                } catch (e) { }
            }
            showModal('–î–∞–Ω–Ω–∏ –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞', `
                <label>–ò–º–µ–Ω–∞:<input type="text" id="info-name" value="${info.name || ''}"></label>
                <label>–¢–µ–ª–µ—Ñ–æ–Ω:<input type="text" id="info-phone" value="${info.phone || ''}"></label>
                <label>–ê–¥—Ä–µ—Å:<textarea id="info-address" rows="3">${info.address || ''}</textarea></label>
            `, () => {
                meta.deliveryInfo = {
                    name: document.getElementById('info-name').value.trim(),
                    phone: document.getElementById('info-phone').value.trim(),
                    address: document.getElementById('info-address').value.trim()
                };
                saveThreadMeta(threadId, meta);
                updateThreadTagButtons(threadId);
            });
        }

        function openNoteModal(threadId) {
            const meta = getThreadMeta(threadId);
            showModal('–ë–µ–ª–µ–∂–∫–∞', `
                <textarea id="note-text" rows="4" placeholder="–ë–µ–ª–µ–∂–∫–∞...">${meta.note || ''}</textarea>
            `, () => {
                meta.note = document.getElementById('note-text').value.trim();
                saveThreadMeta(threadId, meta);
                updateThreadTagButtons(threadId);
            });
        }

        function showModal(title, bodyHtml, onSave) {
            const overlay = document.getElementById('modal-overlay');
            document.getElementById('modal-title').textContent = title;
            const body = document.getElementById('modal-body');
            body.innerHTML = bodyHtml;
            overlay.classList.remove('hidden');
            document.getElementById('modal-save').onclick = () => {
                onSave();
                overlay.classList.add('hidden');
            };
            document.getElementById('modal-close').onclick = () => overlay.classList.add('hidden');
        }

        // --- SETTINGS FUNCTIONS ---
        async function showSettingsView() {
            showView(elements.settingsView);
            elements.statusMessage.textContent = '';
            elements.promptTextarea.value = '–ó–∞—Ä–µ–∂–¥–∞–º —Ç–µ–∫—É—â–∏—è –ø—Ä–æ–º–ø—Ç...';
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/prompt`);
                if (!response.ok) throw new Error((await response.json()).error);
                const data = await response.json();
                elements.promptTextarea.value = data.prompt || '';
            } catch (error) {
                elements.promptTextarea.value = `–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ: ${error.message}`;
            }
        }

        async function savePrompt() {
            const newPrompt = elements.promptTextarea.value;
            setButtonLoading(elements.savePromptButton, true, '–ó–∞–ø–∞–∑–≤–∞–º...');
            showStatusMessage('–ó–∞–ø–∞–∑–≤–∞–º...');
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: newPrompt })
                });
                if (!response.ok) throw new Error((await response.json()).error);
                showStatusMessage('–ü—Ä–æ–º–ø—Ç—ä—Ç –µ –∑–∞–ø–∞–∑–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
            } catch (error) {
                showStatusMessage(`–ì—Ä–µ—à–∫–∞: ${error.message}`, 'error');
            } finally {
                setButtonLoading(elements.savePromptButton, false, '–ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–ø—Ç–∞');
            }
        }

        // --- HELPER FUNCTIONS ---
        function getThreadMeta(id) {
            return JSON.parse(localStorage.getItem(`thread_meta_${id}`) || '{}');
        }

        function saveThreadMeta(id, data) {
            localStorage.setItem(`thread_meta_${id}`, JSON.stringify(data));
        }

        function formatDate(dateStr) {
            if (!dateStr) return '---';
            const d = new Date(dateStr);
            return isNaN(d) ? '---' : d.toLocaleString('bg-BG');
        }

        function setButtonLoading(button, isLoading, loadingText) {
            button.disabled = isLoading;
            if (isLoading) {
                button.dataset.originalText = button.textContent;
                button.textContent = loadingText;
            } else {
                button.textContent = button.dataset.originalText || 'Submit';
            }
        }

        function showStatusMessage(message, type = '') {
            elements.statusMessage.textContent = message;
            elements.statusMessage.className = `status-message ${type}`;
        }

    </script>
</body>
</html>
