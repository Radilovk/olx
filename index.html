<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <!-- –ü–†–û–ú–Ø–ù–ê: –î–æ–±–∞–≤–µ–Ω Viewport –∑–∞ Responsive Design -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OLX Command Center</title>
    <style>
        /* --- General Layout --- */
        :root { --main-blue: #007bff; --light-blue: #e0eafc; --ai-purple: #563d7c; --gray-bg: #f4f4f5; --light-gray: #e9e9eb; --text-dark: #111; --text-light: #555; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; margin: 0; height: 100vh; background-color: var(--gray-bg); font-size: 14px; overflow: hidden; }
        * { box-sizing: border-box; }

        /* --- Sidebar --- */
        #sidebar { width: 350px; border-right: 1px solid #ccc; height: 100%; display: flex; flex-direction: column; background-color: #fff; flex-shrink: 0; }
        .sidebar-header { padding: 10px 15px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { margin: 0; font-size: 1.2em; color: #333; }
        .sidebar-controls { display: flex; align-items: center; font-size: 12px; }
        .sidebar-controls label { margin-right: 10px; }
        .sidebar-controls button { background: none; border: 1px solid #ccc; cursor: pointer; border-radius: 5px; padding: 5px 8px; }
        #threads-list { flex-grow: 1; overflow-y: auto; }
        
        /* --- Broadcast Section --- */
        #broadcast-section { padding: 10px; border-top: 1px solid #ccc; }
        #broadcast-section textarea { width: 100%; resize: vertical; padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 5px; }
        #broadcast-section button { width: 100%; padding: 10px; background-color: var(--ai-purple); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        #broadcast-section button:disabled { background-color: #ccc; }

        /* --- Thread Item in Sidebar --- */
        .thread-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: flex-start; }
        .thread-item:hover { background-color: #f0f0f0; }
        .thread-item.active { background-color: var(--light-blue); border-right: 3px solid var(--main-blue); }
        .thread-item input[type="checkbox"] { margin-right: 10px; margin-top: 4px; }
        .thread-item-info { flex-grow: 1; }
        .thread-item-info p, .thread-item-info small { margin: 0; color: var(--text-light); }
        .thread-item-info p { font-weight: 500; color: var(--text-dark); display: flex; justify-content: space-between; align-items: center; }
        .thread-item-info .short-ad-name { margin-left: 5px; flex-grow: 1; border: 0; border-bottom: 1px dashed #ccc; background: transparent; font-size: 12px; }
        .thread-item-info .short-ad-name:focus { outline: none; border-bottom-color: var(--main-blue); }
        .thread-item.unread .user-name, .thread-item.unread .advert-title { font-weight: bold; }
        .thread-meta { display: flex; flex-direction: column; gap: 4px; margin-left: 5px; }
        .thread-meta select, .thread-meta button { font-size: 11px; }
        .read-toggle, .note-button { background: none; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; padding: 2px 4px; }

        /* --- Main Content Area --- */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100%; }
        #content-area { flex-grow: 1; display: flex; flex-direction: column; }
        .placeholder { text-align: center; color: #888; margin: auto; }
        
        /* --- Chat Header (for Mobile) --- */
        #chat-header { display: none; /* Visible only on mobile */ align-items: center; padding: 10px; border-bottom: 1px solid #ccc; background-color: #f9f9f9;}
        #back-to-threads-button { font-size: 20px; background: none; border: none; cursor: pointer; padding: 0 15px 0 5px; }
        #chat-partner-name { margin: 0; font-size: 1.1em; font-weight: bold; }

        /* --- AI Analyzer Section --- */
        #analyzer-section { padding: 15px; border-bottom: 1px solid #ccc; background-color: #fafafa; }
        #analyzer-section p { margin: 0 0 10px 0; font-weight: bold; }
        .analyzer-input-group { display: flex; }
        #analyzer-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 5px; padding: 8px; }
        #analyzer-button { margin-left: 10px; background-color: var(--ai-purple); color: white; border:none; border-radius:5px; padding: 0 15px; font-weight: bold; cursor: pointer; }
        #analyzer-result { margin-top: 10px; padding: 10px; background-color: #eef; border-radius: 5px; color: #333; }

        /* --- Messages View --- */
        #messages-view { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 18px; max-width: 70%; word-wrap: break-word; line-height: 1.4; }
        .message.sent { background-color: var(--main-blue); color: white; align-self: flex-end; }
        .message.received { background-color: var(--light-gray); color: black; align-self: flex-start; }
        #messages-container { display: flex; flex-direction: column; }

        /* --- Reply Area --- */
        #reply-area { border-top: 1px solid #ccc; padding: 10px; display: flex; background-color: #f9f9f9; align-items: center; flex-shrink: 0; }
        #reply-area textarea { flex-grow: 1; resize: none; border-radius: 18px; border: 1px solid #ccc; padding: 10px; font-size: 14px; line-height: 1.4; }
        #reply-area button { margin-left: 10px; padding: 0 20px; height: 38px; border-radius: 18px; border: none; font-weight: bold; cursor: pointer; transition: background-color 0.2s; white-space: nowrap; }
        #reply-area button#send-button { background-color: var(--main-blue); color: white; }
        #reply-area button#generate-ai-button { background-color: var(--ai-purple); color: white; }
        #reply-area button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- Settings View --- */
        #settings-view { padding: 20px; height: 100%; overflow-y: auto; }
        #settings-view h2 { margin-top: 0; }
        #settings-view textarea { width: 100%; height: 200px; resize: vertical; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #settings-view button { padding: 10px 20px; background-color: var(--main-blue); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #status-message { margin-top: 10px; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }

        /* --- General Helpers --- */
        .hidden { display: none !important; }
        #loader, #messages-loader { text-align: center; padding: 20px; color: #888; }
        
        /* –ü–†–û–ú–Ø–ù–ê: –ú–µ–¥–∏–π–Ω–∏ –∑–∞—è–≤–∫–∏ –∑–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ */
        @media (max-width: 768px) {
            body { font-size: 16px; }
            #sidebar { width: 100%; border-right: none; }
            #main-content { width: 100%; }

            /* –ö–ª–∞—Å –∑–∞ —Å–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∏ –≤ –º–æ–±–∏–ª–µ–Ω –∏–∑–≥–ª–µ–¥ */
            .mobile-hidden {
                display: none !important;
            }
            
            #chat-header {
                display: flex;
            }

            #chat-view, #settings-view {
                height: 100vh;
            }
            
            .message { max-width: 85%; }
            #reply-area textarea { padding: 12px; }
            #reply-area button { height: 42px; padding: 0 15px; }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR: –°–ø–∏—Å—ä–∫ —Å —Ä–∞–∑–≥–æ–≤–æ—Ä–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–∞ –≥—Ä—É–ø–æ–≤–∏ —Å—ä–æ–±—â–µ–Ω–∏—è -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h2>–†–∞–∑–≥–æ–≤–æ—Ä–∏</h2>
            <div class="sidebar-controls">
                <label><input type="checkbox" id="select-all-checkbox"> –í—Å–∏—á–∫–∏</label>
                <button id="refresh-button">üîÑ</button>
                <button id="settings-button" style="margin-left: 5px;">‚öôÔ∏è</button>
            </div>
        </div>
        <div id="loader">–ó–∞—Ä–µ–∂–¥–∞–º —Ä–∞–∑–≥–æ–≤–æ—Ä–∏...</div>
        <div id="threads-list"></div>
        <div id="broadcast-section" class="hidden">
            <textarea id="broadcast-message" rows="4" placeholder="–ù–∞–ø–∏—à–µ—Ç–µ –≥—Ä—É–ø–æ–≤–æ —Å—ä–æ–±—â–µ–Ω–∏–µ..."></textarea>
            <button id="broadcast-button" disabled>–ò–∑–ø—Ä–∞—Ç–∏ –Ω–∞ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ (0)</button>
        </div>
    </div>

    <!-- MAIN CONTENT: –ú—è—Å—Ç–æ –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —á–∞—Ç, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¥—Ä. -->
    <div id="main-content">
        <div id="content-area">
            <!-- –ù–∞—á–∞–ª–µ–Ω –∏–∑–≥–ª–µ–¥ -->
            <div id="placeholder-view" class="placeholder">
                <h1>OLX Command Center</h1>
                <p>–ò–∑–±–µ—Ä–µ—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä –æ—Ç–ª—è–≤–æ, –∑–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—Ç–µ.</p>
            </div>

            <!-- –ò–∑–≥–ª–µ–¥ –∑–∞ —á–∞—Ç -->
            <div id="chat-view" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                <!-- –ü–†–û–ú–Ø–ù–ê: –î–æ–±–∞–≤–µ–Ω —Ö–µ–¥—ä—Ä –∑–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
                <div id="chat-header">
                    <button id="back-to-threads-button">&larr; –û–±—Ä–∞—Ç–Ω–æ</button>
                    <h3 id="chat-partner-name"></h3>
                </div>
                <div id="analyzer-section">
                    <p>AI –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞</p>
                    <div class="analyzer-input-group">
                        <input type="text" id="analyzer-input" placeholder="–ù–∞–ø—Ä. '–ö–∞–∫—ä–≤ –µ –∞–¥—Ä–µ—Å—ä—Ç –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞?'">
                        <button id="analyzer-button">–ü–∏—Ç–∞–π AI</button>
                    </div>
                    <div id="analyzer-result" class="hidden"></div>
                </div>
                <div id="messages-view"></div>
                <div id="reply-area">
                    <textarea id="reply-text" rows="1" placeholder="–ù–∞–ø–∏—à–µ—Ç–µ –æ—Ç–≥–æ–≤–æ—Ä..."></textarea>
                    <button id="send-button">–ò–∑–ø—Ä–∞—Ç–∏</button>
                    <button id="generate-ai-button" class="ai-button">‚ú®</button>
                </div>
            </div>

            <!-- –ò–∑–≥–ª–µ–¥ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div id="settings-view" class="hidden">
                 <!-- –ü–†–û–ú–Ø–ù–ê: –î–æ–±–∞–≤–µ–Ω —Ö–µ–¥—ä—Ä —Å –±—É—Ç–æ–Ω –∑–∞ –≤—Ä—ä—â–∞–Ω–µ –∏ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ -->
                <div id="chat-header">
                    <button id="back-to-threads-button-settings">&larr; –û–±—Ä–∞—Ç–Ω–æ</button>
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                </div>
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ AI –ê—Å–∏—Å—Ç–µ–Ω—Ç–∞</h2>
                <p>–¢—É–∫ –º–æ–∂–µ—Ç–µ –¥–∞ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–∏—è –ø—Ä–æ–º–ø—Ç, –∫–æ–π—Ç–æ AI –∏–∑–ø–æ–ª–∑–≤–∞, –∑–∞ –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏. –û–ø–∏—à–µ—Ç–µ –∫–∞–∫–≤–∞ —Ä–æ–ª—è –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–≥—Ä–∞–µ, –∫–∞–∫—ä–≤ —Ç–æ–Ω –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞ –∏ —Ç.–Ω.</p>
                <textarea id="prompt-textarea"></textarea>
                <button id="save-prompt-button">–ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–ø—Ç–∞</button>
                <div id="status-message"></div>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = 'https://olx.radilov-k.workers.dev';
        const AUTH_URL = 'https://www.olx.bg/oauth/authorize?response_type=code&client_id=200383&redirect_uri=https://olx.radilov-k.workers.dev/callback&scope=read+write+v2&state=random_string_12345';
        
        // --- STATE ---
        let currentThreadId = null;
        const IS_MOBILE = window.innerWidth <= 768;

        // --- DOM ELEMENTS ---
        const elements = {
            sidebar: document.getElementById('sidebar'),
            mainContent: document.getElementById('main-content'),
            loader: document.getElementById('loader'),
            threadsList: document.getElementById('threads-list'),
            selectAllCheckbox: document.getElementById('select-all-checkbox'),
            refreshButton: document.getElementById('refresh-button'),
            settingsButton: document.getElementById('settings-button'),
            broadcastSection: document.getElementById('broadcast-section'),
            broadcastMessage: document.getElementById('broadcast-message'),
            broadcastButton: document.getElementById('broadcast-button'),
            placeholderView: document.getElementById('placeholder-view'),
            chatView: document.getElementById('chat-view'),
            settingsView: document.getElementById('settings-view'),
            messagesView: document.getElementById('messages-view'),
            replyText: document.getElementById('reply-text'),
            sendButton: document.getElementById('send-button'),
            generateAiButton: document.getElementById('generate-ai-button'),
            analyzerInput: document.getElementById('analyzer-input'),
            analyzerButton: document.getElementById('analyzer-button'),
            analyzerResult: document.getElementById('analyzer-result'),
            promptTextarea: document.getElementById('prompt-textarea'),
            savePromptButton: document.getElementById('save-prompt-button'),
            statusMessage: document.getElementById('status-message'),
            chatPartnerName: document.getElementById('chat-partner-name'),
            backToThreadsButton: document.getElementById('back-to-threads-button'),
            backToThreadsButtonSettings: document.getElementById('back-to-threads-button-settings'),
        };

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            if (IS_MOBILE) {
                elements.mainContent.classList.add('mobile-hidden');
            }
            fetchThreads();
            
            elements.refreshButton.addEventListener('click', fetchThreads);
            elements.settingsButton.addEventListener('click', showSettingsView);
            elements.selectAllCheckbox.addEventListener('change', handleSelectAll);
            elements.threadsList.addEventListener('change', e => {
                if (e.target.classList.contains('thread-checkbox')) updateBroadcastCounter();
            });
            
            elements.sendButton.addEventListener('click', sendMessage);
            elements.generateAiButton.addEventListener('click', generateAiReply);
            elements.analyzerButton.addEventListener('click', analyzeThread);
            elements.broadcastButton.addEventListener('click', sendBroadcastMessage);
            elements.savePromptButton.addEventListener('click', savePrompt);

            // –ü–†–û–ú–Ø–ù–ê: Event listeners –∑–∞ –±—É—Ç–æ–Ω–∏—Ç–µ "–û–±—Ä–∞—Ç–Ω–æ"
            elements.backToThreadsButton.addEventListener('click', showThreadsViewOnMobile);
            elements.backToThreadsButtonSettings.addEventListener('click', showThreadsViewOnMobile);
        });

        // --- VIEW MANAGEMENT ---
        function showView(viewToShow) {
            [elements.placeholderView, elements.chatView, elements.settingsView].forEach(view => {
                view.classList.add('hidden');
            });
            viewToShow.classList.remove('hidden');

            if (IS_MOBILE) {
                elements.sidebar.classList.add('mobile-hidden');
                elements.mainContent.classList.remove('mobile-hidden');
            }
        }

        // –ü–†–û–ú–Ø–ù–ê: –ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –º–æ–±–∏–ª–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
        function showThreadsViewOnMobile() {
            if (IS_MOBILE) {
                elements.mainContent.classList.add('mobile-hidden');
                elements.sidebar.classList.remove('mobile-hidden');
                document.querySelectorAll('.thread-item').forEach(el => el.classList.remove('active'));
                currentThreadId = null;
            }
        }

        // --- CORE FUNCTIONS ---

        const advertCache = new Map();

        async function getAdvert(id) {
            if (!id) return null;
            if (advertCache.has(id)) return advertCache.get(id);
            const lsKey = `advert_${id}`;
            const cached = localStorage.getItem(lsKey);
            if (cached) {
                const advert = JSON.parse(cached);
                advertCache.set(id, advert);
                return advert;
            }
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/adverts/${id}`);
                if (!response.ok) throw new Error('Advert fetch failed');
                const advert = await response.json();
                advertCache.set(id, advert);
                localStorage.setItem(lsKey, JSON.stringify(advert));
                return advert;
            } catch (err) {
                return null;
            }
        }

        async function fetchThreads() {
            elements.loader.classList.remove('hidden');
            elements.threadsList.innerHTML = '';
            try {
                const response = await authorizedFetch(`${API_BASE_URL}/api/threads`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`${errorData.error} <a href="${AUTH_URL}">–û—Ç–æ—Ä–∏–∑–∏—Ä–∞–π—Ç–µ —Å–µ –æ—Ç–Ω–æ–≤–æ</a>.`);
                }
                const threads = await response.json();
                if (!threads || threads.length === 0) {
                    elements.threadsList.innerHTML = '<p style="padding: 15px;">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏.</p>';
                    return;
                }

                for (const thread of threads) {
                    const meta = getThreadMeta(thread.id);
                    if (thread.advert_id) {
                       const advert = await getAdvert(thread.advert_id);
                        if (advert && advert.data) {
                            meta.advertTitle = advert.data.title;
                        }
                    }

                    const threadElement = document.createElement('div');
                    threadElement.className = 'thread-item';
                    threadElement.dataset.threadId = thread.id;
                    if (thread.unread_count > 0) threadElement.classList.add('unread');

                    const lastDate = formatDate(thread.last_message_date);
                    
                    // –ü–†–û–ú–Ø–ù–ê: –ö–æ—Ä–∏–≥–∏—Ä–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞ –∏–º–µ—Ç–æ. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –µ –Ω–∞ —Å—ä–±–µ—Å–µ–¥–Ω–∏–∫–∞.
                    const interlocutorName = thread.interlocutor?.name || meta.contactName || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª';
                    const advertTitle = meta.advertTitle || '';

                    threadElement.innerHTML = `
                        <input type="checkbox" class="thread-checkbox" data-id="${thread.id}">
                        <div class="thread-item-info">
                            <p><span class="user-name">${interlocutorName}</span></p>
                            <small class="advert-title">${advertTitle}</small>
                            <small>–ü–æ—Å–ª–µ–¥–Ω–æ: ${lastDate}</small>
                        </div>
                    `;

                    threadElement.querySelector('.thread-item-info').addEventListener('click', () => {
                        document.querySelectorAll('.thread-item').forEach(el => el.classList.remove('active'));
                        threadElement.classList.add('active');
                        displayMessages(thread.id, interlocutorName);
                    });

                    elements.threadsList.appendChild(threadElement);
                }
            } catch (error) {
                elements.threadsList.innerHTML = `<p style="color: red; padding: 15px;">${error.message}</p>`;
            } finally {
                elements.loader.classList.add('hidden');
            }
        }

        async function displayMessages(threadId, interlocutorName = '') {
            currentThreadId = threadId;
            elements.chatPartnerName.textContent = interlocutorName;
            showView(elements.chatView);
            elements.messagesView.innerHTML = '<div id="messages-loader">–ó–∞—Ä–µ–∂–¥–∞–º —Å—ä–æ–±—â–µ–Ω–∏—è—Ç–∞...</div>';
            elements.analyzerResult.c
